---
title: 查询性能优化
author: chaizz
date: 2023-9-17
tags: MySQL
categories:
    - 读书笔记
    - 高性能MySQL(第四版)
photos: ["https://origin.chaizz.com/tc/HighPerformanceMysql.png"]
cover: "https://origin.chaizz.com/tc/HighPerformanceMysql.png"
---



# 查询性能优化



## 优化数据访问

1、是否在查询中包含了大量的不需要的行

2、服务器是否在分析大量的不需要的行。

针对第一点我们要规避的一些操作：

- 查询了100行 只显示10行。
- 多表连接时返回全部列。
- 使用select * from ...。
- 重复查询相同的数据。

针对第二点如何确保MySQL是否在扫描一些额外的记录，我们可以通过三个指标进行衡量：响应时间、扫描行数、返回的行数。这是哪个指标们记录到MySQL的慢查询日志中。



## MySQL 执行计划的知识补充

我们主要查看两个字段的含义：

type：代表我们的查询使用了哪种类型的查询分别有：

system > const > eq_ref > ref > range > index > all。 此值一般要超过range，最好是达到ref是比较合格的一个查询。

Extra: 解析查询的额外信息

Using index：使用索引覆盖扫描（在Extra列中出现了Using index）来返回记录，直接从索引中过滤不需要的记录并返回命中的结果。这是在MySQL服务器层完成的，但无须再回表查询记录。 

Using where：从数据表中返回数据，然后过滤不满足条件的记录。这在MySQL服务器层完成，MySQL需要先从数据表中读出记录然后过滤。



发现查询需要扫描大量的数据但只返回少数行，可以尝试下面的技巧去优化它：

- 使用索引覆盖扫描，把所有需要用的列都放到索引中，这样存储引擎无须回表获取对应行就可以返回结果了。
- 改变库表结构。例如，使用单独的汇总表（这是我们在第6章中讨论的办法）。
- 重写这个复杂的查询，让MySQL优化器能够以更优化的方式执行这个查询



## 优化特定类型的查询

### 优化 count()查询

count()函数的作用①：统计某列的值的数量，也可以统计行数。在统计列的值时，不会包含null的列。

作用②：统计结果集的行数，当MySQL确认括号中的表达式不为空时，实际上就是在统计行数，最基本的例子，当我们使用count(*)时，"\*"并不会扩展成所有的列，他会忽略所有的列，而统计所有的行。当我们需要统计行数是应该始终使用count(\*)，这样既可以清晰地传达意图也可以保持性能。

使用近似值，某些业务场景并不要求完全精确的统计值，此时可以用近似值来代替。EXPLAIN出来的优化器估算的行数就是一个不错的近似值，执行EXPLAIN并不需要真正地去执行查询，所以成本很低。



### 优化连接查询

1、确保on或者using子句中的列上有索引，一般来说，有其他的理由，只在连接表的第二个表的相应的列上建立索引。

2、确保ORDER BY 和 GROUP BY 中的表达式只涉及一个表的列。

3、很多时候将聚合操作放在程序中是好的。



### 优化 LIMIT 和 OFFSET 子句

在查询时通常会使用LIMIT和OFFSET进行分页，但是当偏移量特别大的时候吗，就会导致前面的大量数据被抛弃。优化这种查询的方法就是，尽可能的使用索引覆盖。

一个例字

```sql
select film_id, description from sakila.film order by title limit 50, 5;
```

如果表非常大，建议改成下面的这样的查询：

```sql
select film.film_id, film.description from sakila.film inner join （select film.id from sakila.film order by title limit 50, 5） as lim using(film_id);
```

这种“延迟联接”之所以有效，是因为它允许服务器在不访问行的情况下检查索引中尽可能少的数据，然后，一旦找到所需的行，就将它们与整个表联接，以从该行中检索其他列。

如果能有类似书签的工具记录上次查询的位置，那么下次扫描就可以从记录的位置开始扫描。

分页的一个功能是返回所有的行的总数，这同样是一个需要扫描所有满足条件的行，我们可以使用下一页来设计分页，不记录总行数，当去查询20条数据时，我们获取21条， 如果有第21条，那么下一页按钮是可用的，如果不包含，那么证明没有那么多条数据了。



### 优化UNION查询

除非你确实需要服务器消除重复的行，否则一定要使用UNION ALL，这一点很重要。如果没有ALL关键字，MySQL会给临时表加上DISTINCT选项，这会导致对整个临时表的数据做唯一性检查。这样做的代价非常高。即使有ALL关键字，MySQL仍然会使用临时表存储结果。
